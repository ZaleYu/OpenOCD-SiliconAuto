# SPDX-License-Identifier: GPL-2.0-or-later

# script for SiliconAuto Cortex-M Series

# --- adapter / transport (your interface cfg can still override these) ---
adapter speed 4000
transport select swd

# --- chip / target names (can be overridden via: -c "set CHIPNAME foo") ---
if { [info exists CHIPNAME] } {
    set _CHIPNAME $CHIPNAME
} else {
    set _CHIPNAME XMicro1
}
set _TARGETNAME $_CHIPNAME.cpu

# --- create DAP and Cortex-M target ---
source [find target/swj-dp.tcl]
# If you know the DAP IDCODE, add:  -expected-id 0x........
swj_newdap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xF
dap create $_CHIPNAME.dap -chain-position $_CHIPNAME.cpu

target create $_TARGETNAME cortex_m -endian little -dap $_CHIPNAME.dap

# --- reset & connect (no SRST line) ---
reset_config none
cortex_m reset_config sysresetreq

# --- work area (SRAM) ---
# If unsure, start with 16KB and no backup. Override via WORKAREAADDR/WORKAREASIZE.
if { [info exists WORKAREASIZE] } {
    set _WORKAREASIZE $WORKAREASIZE
} else {
    set _WORKAREASIZE 0x4000
}
if { [info exists WORKAREAADDR] } {
    set _WORKAREAADDR $WORKAREAADDR
} else {
    set _WORKAREAADDR 0x20400000
}
$_TARGETNAME configure -work-area-phys $_WORKAREAADDR -work-area-size $_WORKAREASIZE -work-area-backup 0

# --- flash parameters (tune to your controller) ---
if { ![info exists FLASH_BASE] } { set FLASH_BASE 0x02000000 }  ;# PFlash base
if { ![info exists FLASH_SIZE] } { set FLASH_SIZE 0x00100000 }  ;# 1MB
# Controller timing needs core clock. Default 24 MHz. Override with: -c "set CORECLK_HZ 120000000"
if { ![info exists CORECLK_HZ] } { set CORECLK_HZ 24000000 }

# --- declare flash bank ---
# flash bank <name> <driver> <base> <size> <chip_width> <bus_width> <target> [extra...]
# Your bank_command reads CORECLK_HZ as the extra argument.
flash bank xm0 xmicro1 $FLASH_BASE $FLASH_SIZE 0 0 $_TARGETNAME $CORECLK_HZ

proc exitDebugging {} {
    if {[using_hla]} { hla_close }
    shutdown
}

$_TARGETNAME configure -event gdb-detach { exitDebugging }

# --- quick usage ---
# init
# reset halt
# flash info 0
# flash erase_sector xm0 0 3
# flash write_image erase myfw.bin $FLASH_BASE
# verify_image myfw.bin $FLASH_BASE
# reset run
# shutdown

